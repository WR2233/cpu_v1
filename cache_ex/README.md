#キャッシュコントローラ仕様書


## 1. キャッシュ構成
本モジュールは、DRAMへのメモリアクセスレイテンシを削減するための2-Wayセットアソシエイティブ方式キャッシュです。

| 項目 | 設定値 | 説明 |
| :--- | :--- | :--- |
| **方式** | 2-Wayセットアソシエイティブ | 各インデックスに2つのエントリ（Way）を持つ |
| **ラインサイズ** | 128ビット (16バイト) | DRAMとのデータ転送の最小単位 |
| **インデックス数** | 4,096 セット | 12bitのインデックス幅を使用 |
| **総容量** | 128 KB | (128bit × 4,096 index × 2 Way) |
| **置換アルゴリズム** | LRU (Least Recently Used) | BRAM(lru_bram)で各セットの直近使用情報を管理 |
| **書き込みポリシー** | ライトバック (Write-back) | ヒット時にDirtyビットを立て、ミス時の入替え時にDRAMへ書き戻す |
| **動作タイプ** | ブロッキング | ミスハンドリング中はCPUをストールさせる |



---

## 2. アドレス解釈 (27ビット想定)
CPUから入力されるアドレス（`read_addr`, `write_addr`）のうち、27ビットを以下のように分割して管理します。

| フィールド | ビット範囲 | 幅 | 説明 |
| :--- | :--- | :--- | :--- |
| **Tag** | `[26:16]` | 11 bit | ヒット判定用の識別子 |
| **Index** | `[15:4]` | 12 bit | 4,096エントリの行選択 |
| **Offset** | `[3:0]` | 4 bit | ライン内の位置 (Word選択には `[3:2]` を使用) |

---

## 3. CPUハンドシェイク仕様
CPUとキャッシュ間は、信号の有効/受理を確認し合うハンドシェイク形式で動作します。

### 信号一覧
- **`mem_req_ready` (Output)**: キャッシュが新しい要求を受け入れ可能な状態 (`1` = Ready)。
- **`cpu_read_ready` / `write_enable` (Input)**: CPUからの要求有効信号。
- **`mem_data_valid` (Output)**: 読み出しデータの確定、または書き込みの受理完了を示す。

### 動作サイクル
1. **要求発行**: CPUは `mem_req_ready` が `1` のとき、アドレスと有効信号（Read/Write）をセットします。
2. **ヒット時 (2サイクル)**:
   - キャッシュ内にデータがあれば即座に(コアとのハンドシェイクが成立した次のサイクルで)`mem_data_valid` を返します。
   - 連続して `mem_req_ready` が `1` を維持している間は、パイプライン的に要求を送ることが可能です。
3. **ミス時 (ストール)**:
   - ヒットしなかった場合、`mem_req_ready` が `0` になり、内部FSMがDRAMへのリフィル動作に入ります。
   - 雑に50サイクル後にキャッシュラインの更新と応答が行われ, その次のサイクルでmem_req_rdyが立つようになるとしてください
   - writeのmissの場合もcpuは次の動作に進むことはできますがmem_req_rdyは立たないのでキャッシュへ要求は送れません



---

## 4. 追加機能要望
キャッシュの性能検討をするために以下のパラメータを可変にしてほしいです

- way数(1,2,4)
- ラインサイズ(128,256,512)(それに応じてOffset長も増えることに注意してください) 

