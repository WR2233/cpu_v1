# compiler v1

## 必要なツール

- cargo 1.86.0
- ocaml 5.3.0
- dune  3.18.0

## 実行方法

`min-caml/test/fib.ml`をコンパイルしたい場合、
```
$ ./run.sh min-caml/test/fib
```
を実行してください(`.ml`はつけない)

最後に`-r`オプションをつけるとreleaseバージョンでの実行になります。コンパイルが速くなります。基本的につけましょう。
```
$ ./run.sh min-caml/test/fib -r
```

また、アセンブリ機械語に変換するには`asm/`にあるライブラリを一緒にアセンブラに渡さなければいけませんが、全部指定するのは面倒くさいので、それも自動化しました。デフォルトでは`output/${filename}.hex`が出力されます。`.bin`を出したい場合などは、`run.sh`を適宜いじってください。

**Windowsでは動かないような気がする**

## min-rtのコンパイル方法

このコンパイラは外部配列を認めていないので、配布されている`minrt-original.ml`は単体ではコンパイルできません。`minrt-<num>.ml`というファイルは、外部配列の定義などが書かれている`globals.ml`の中身を先頭にコピペしてあるので、min-rtをコンパイルしたい場合はそちらを使ってください。たとえば、

```
$ ./run.sh cpuex-v1.6/raytracer/minrt-256.ml -r
```

を実行すると、`output/minrt-256.hex`ができるはずです。

## ライブラリ

ライブラリは`asm/`にあります。min-rtで使っているライブラリファイルは5つで、それぞれの内容は以下の通りです。

- `io.riscvreg`: 入出力をします
- `lib.riscv`: 配列作成関数が含まれます
- `mathblt.riscv`: 小数演算のラッパー関数です。`fneg`, `flt`なども関数を通して呼び出されます
- `math.riscvreg`: `sin`, `cos`, `atan`が実装されています
- `const.riscv`: `math.riscvreg`で使われる小数定数です

大体のプログラムはこれらがないとアセンブルできません。アセンブラやシミュレータに通すときは本体のアセンブリと一緒にライブラリもこの順で渡してください。

## エラーメッセージ

このコンパイラはエラーメッセージが優しくないので、コンパイラエラーに出会ったら、.mlファイルとエラーメッセージを合わせて教えてください。
